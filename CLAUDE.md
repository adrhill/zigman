# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Workflow

After any change to `.typ`, `.lua`, or `flake.nix` files, always rebuild the PDF to verify:

```bash
nix develop --command typst compile main.typ zigman.pdf
```

## Project Purpose

Zigman renders the [Zig language reference](https://ziglang.org/documentation/master/) as a beautifully typeset PDF suitable for e-book readers (e.g. Kindle, Kobo, reMarkable). It uses **Pandoc** to convert HTML to Typst markup, **Typst** for document layout, and **Nix** for reproducible builds.

## Build Commands

```bash
# Build the PDF via Nix (reproducible, preferred)
nix build

# Build the PDF directly with Typst during development
# (requires content.typ from pandoc — see pipeline below)
typst compile main.typ zigman.pdf

# Watch for changes and recompile automatically
typst watch main.typ zigman.pdf
```

## Pipeline

```
ziglang.org/documentation/master/ (fetchurl)
  → pandoc -f html -t typst --lua-filter=filter.lua
  → sed (strip toc- links)
  → content.typ
  → typst compile main.typ
  → zigman.pdf
```

## Architecture

### Files

- **`flake.nix`** — Nix flake that orchestrates the full build: fetch HTML → pandoc convert → typst compile. Also provides a dev shell with pandoc, typst, and curl.
- **`filter.lua`** — Pandoc Lua filter that cleans Zig-specific HTML quirks: strips `#navigation` sidebar, removes `.hdr` anchor links, maps `figcaption` language classes (`.zig-cap`, `.c-cap`, `.shell-cap`) to code block languages, strips `.tok-*` syntax highlighting spans.
- **`main.typ`** — Typst entry point. Sets page size, margins, fonts, heading/code/table/link styles, title page, and table of contents. Includes `content.typ` (generated by Pandoc).
- **`content.typ`** — Generated file (not committed). Pandoc output included by `main.typ`.

### Build Stages

1. **Fetch**: `fetchurl` downloads the Zig language reference HTML from ziglang.org.
2. **Convert**: Pandoc converts HTML → Typst markup, using `filter.lua` for cleanup. A `sed` post-process strips Pandoc's `#link(<toc-...>)` wrappers from headings.
3. **Typeset**: Typst compiles `main.typ` (which includes `content.typ`) into a PDF. Default page size is 4.2"×5.6" (Boox Go Color 7), customizable via `--input page-width=... --input page-height=...`.

Nix ties all stages together into a single reproducible build via `flake.nix`.

## CI

PDF builds run on **GitHub Actions** using the Nix flake. The workflow (`.github/workflows/build.yml`) installs Nix with flakes enabled, runs `nix build`, and deploys the PDF to GitHub Pages on pushes to `main`.

## Key Technologies

- **Pandoc** — converts the Zig reference HTML to Typst markup. Uses `--lua-filter` flag.
- **Typst** — modern typesetting system. Files use `.typ` extension. Docs: https://typst.app/docs
- **Nix flakes** — reproducible builds and dependency management. Entry point: `flake.nix`
- **GitHub Actions** — CI runs `nix build` to produce the PDF. Workflow lives in `.github/workflows/`.

## Updating the Zig Reference

When the Zig documentation updates, you need to update the `fetchurl` hash in `flake.nix`:

```bash
nix-prefetch-url --type sha256 "https://ziglang.org/documentation/master/index.html"
# Then convert to SRI: nix hash convert --to sri --hash-algo sha256 <hash>
# Update the hash in flake.nix
```
